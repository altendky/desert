language: ruby
os: linux
branches:
  only:
    # Build tags and branches named master or starting with
    # 'v' followed by a digit, such as for version tags.
    - master
    - /^v\d.*$/
services:
  - docker
jobs:
  include:
    - env:
        - TOXENV=py36,report,codecov
    - env:
        - TOXENV=py37,report,codecov
    - env:
        - TOXENV=py38,report,codecov
    - env:
        - TOXENV=pypy3,report,codecov
    - env:
        - TOXENV=doc
    - env:
        - TOXENV=check
install:
  - docker pull altendky/hydra
script:
  - docker run --rm -it --entrypoint ./in_docker.sh -v $(pwd):/wd -e "TOXENV=${TOXENV}" altendky/hydra /bin/bash in_docker.sh
  - |
    set -ex
    if [[ $TOXENV == 'check' ]]; then
        (gem install travis --no-rdoc --no-ri
         travis lint --no-interactive --exit-code)
    fi
    set +x
after_failure:
  - more .tox/log/* | cat
  - more .tox/*/log/* | cat
notifications:
  email:
    on_success: never
    on_failure: always
